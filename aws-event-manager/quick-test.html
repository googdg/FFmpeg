<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWSæ´»åŠ¨ç®¡ç†ç³»ç»Ÿ - å¿«é€Ÿæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .disabled {
            background: #6c757d !important;
            cursor: not-allowed !important;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª AWSæ´»åŠ¨ç®¡ç†ç³»ç»Ÿ - å¿«é€Ÿæµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ” 1. ç³»ç»Ÿè¿æ¥æµ‹è¯•</h2>
        <button onclick="testConnection()">æµ‹è¯•æœåŠ¡å™¨è¿æ¥</button>
        <div id="connectionResult"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ” 2. ç®¡ç†å‘˜ç™»å½•æµ‹è¯•</h2>
        <div class="form-group">
            <label>ç”¨æˆ·å:</label>
            <input type="text" id="username" value="admin">
        </div>
        <div class="form-group">
            <label>å¯†ç :</label>
            <input type="password" id="password" value="admin123">
        </div>
        <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¯ 3. æ´»åŠ¨åˆ›å»ºæµ‹è¯•</h2>
        <div class="form-group">
            <label>æ´»åŠ¨æ ‡é¢˜:</label>
            <input type="text" id="eventTitle" value="æµ‹è¯•æ´»åŠ¨ - AWSå¼€å‘è€…èšä¼š">
        </div>
        <div class="form-group">
            <label>æ´»åŠ¨æ—¥æœŸ:</label>
            <input type="date" id="eventDate" value="2024-12-15">
        </div>
        <div class="form-group">
            <label>æ´»åŠ¨æ—¶é—´:</label>
            <input type="time" id="eventTime" value="14:00">
        </div>
        <div class="form-group">
            <label>æ´»åŠ¨åœ°ç‚¹:</label>
            <input type="text" id="eventLocation" value="åŒ—äº¬å¸‚æœé˜³åŒºAWSåŠå…¬å®¤">
        </div>
        <div class="form-group">
            <label>æ´»åŠ¨æè¿°:</label>
            <textarea id="eventDescription" rows="3">è¿™æ˜¯ä¸€ä¸ªAWSå¼€å‘è€…ç¤¾åŒºçš„æŠ€æœ¯åˆ†äº«æ´»åŠ¨ï¼Œæ¬¢è¿æ‰€æœ‰å¯¹äº‘è®¡ç®—æ„Ÿå…´è¶£çš„å¼€å‘è€…å‚åŠ ã€‚</textarea>
        </div>
        <button onclick="testCreateEvent()" id="createEventBtn" class="disabled" disabled>æµ‹è¯•åˆ›å»ºæ´»åŠ¨ (éœ€è¦å…ˆç™»å½•)</button>
        <div id="createEventResult"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ 4. ç”¨æˆ·æŠ¥åæµ‹è¯•</h2>
        <div class="form-group">
            <label>å§“å:</label>
            <input type="text" id="regName" value="å¼ ä¸‰">
        </div>
        <div class="form-group">
            <label>å…¬å¸:</label>
            <input type="text" id="regCompany" value="æµ‹è¯•ç§‘æŠ€æœ‰é™å…¬å¸">
        </div>
        <div class="form-group">
            <label>èŒä½:</label>
            <input type="text" id="regPosition" value="å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ">
        </div>
        <div class="form-group">
            <label>æ‰‹æœºå·:</label>
            <input type="tel" id="regPhone" value="13800138000">
        </div>
        <div class="form-group">
            <label>é‚®ç®±:</label>
            <input type="email" id="regEmail" value="zhangsan@test.com">
        </div>
        <button onclick="testRegistration()" id="registrationBtn" class="disabled" disabled>æµ‹è¯•æŠ¥å (éœ€è¦å…ˆåˆ›å»ºæ´»åŠ¨)</button>
        <div id="registrationResult"></div>
    </div>

    <div class="test-section">
        <h2>âœ… 5. ç­¾åˆ°åŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="testCheckin()" id="checkinBtn" class="disabled" disabled>æµ‹è¯•ç­¾åˆ° (éœ€è¦å…ˆæŠ¥å)</button>
        <div id="checkinResult"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š 6. æ•°æ®æŸ¥è¯¢æµ‹è¯•</h2>
        <button onclick="testDataQuery()" id="queryBtn" class="disabled" disabled>æµ‹è¯•æ•°æ®æŸ¥è¯¢ (éœ€è¦å…ˆç™»å½•)</button>
        <div id="queryResult"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•ç»“æœæ±‡æ€»</h2>
        <div id="summaryResult">
            <div class="info">è¯·æŒ‰é¡ºåºæ‰§è¡Œä¸Šè¿°æµ‹è¯•ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•æµ‹è¯•ç»“æœã€‚</div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let authToken = null;
        let currentEventId = null;
        let currentRegistrationId = null;
        let testResults = {
            connection: false,
            login: false,
            createEvent: false,
            registration: false,
            checkin: false,
            dataQuery: false
        };

        // æ˜¾ç¤ºç»“æœçš„è¾…åŠ©å‡½æ•°
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonStates() {
            document.getElementById('createEventBtn').disabled = !testResults.login;
            document.getElementById('createEventBtn').className = testResults.login ? '' : 'disabled';
            
            document.getElementById('registrationBtn').disabled = !testResults.createEvent;
            document.getElementById('registrationBtn').className = testResults.createEvent ? '' : 'disabled';
            
            document.getElementById('checkinBtn').disabled = !testResults.registration;
            document.getElementById('checkinBtn').className = testResults.registration ? '' : 'disabled';
            
            document.getElementById('queryBtn').disabled = !testResults.login;
            document.getElementById('queryBtn').className = testResults.login ? '' : 'disabled';
        }

        // æ›´æ–°æµ‹è¯•æ±‡æ€»
        function updateSummary() {
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r).length;
            const failed = total - passed;

            let summaryHtml = `
                <div class="info">
                    <strong>æµ‹è¯•è¿›åº¦:</strong> ${passed}/${total} é¡¹é€šè¿‡
                </div>
            `;

            if (passed === total) {
                summaryHtml += `
                    <div class="success">
                        ğŸ‰ <strong>æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼</strong> ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œå¯ä»¥æ­£å¼ä½¿ç”¨ã€‚
                    </div>
                `;
            } else if (failed > 0) {
                summaryHtml += `
                    <div class="error">
                        âŒ <strong>å‘ç° ${failed} ä¸ªé—®é¢˜</strong>ï¼Œè¯·æ£€æŸ¥ç›¸å…³åŠŸèƒ½ã€‚
                    </div>
                `;
            }

            document.getElementById('summaryResult').innerHTML = summaryHtml;
        }

        // 1. æµ‹è¯•æœåŠ¡å™¨è¿æ¥
        async function testConnection() {
            try {
                showResult('connectionResult', 'æ­£åœ¨æµ‹è¯•æœåŠ¡å™¨è¿æ¥...', 'info');
                const response = await fetch('/api/events');
                if (response.ok) {
                    testResults.connection = true;
                    showResult('connectionResult', 'âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸ï¼', 'success');
                } else {
                    testResults.connection = false;
                    showResult('connectionResult', `âŒ æœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status}`, 'error');
                }
            } catch (error) {
                testResults.connection = false;
                showResult('connectionResult', `âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
            updateSummary();
        }

        // 2. æµ‹è¯•ç®¡ç†å‘˜ç™»å½•
        async function testLogin() {
            try {
                showResult('loginResult', 'æ­£åœ¨æµ‹è¯•ç™»å½•...', 'info');
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (data.success && data.data.token) {
                    authToken = data.data.token;
                    testResults.login = true;
                    showResult('loginResult', `âœ… ç™»å½•æˆåŠŸï¼æ¬¢è¿ ${data.data.user.username}`, 'success');
                } else {
                    testResults.login = false;
                    showResult('loginResult', `âŒ ç™»å½•å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                testResults.login = false;
                showResult('loginResult', `âŒ ç™»å½•è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
            updateButtonStates();
            updateSummary();
        }

        // 3. æµ‹è¯•åˆ›å»ºæ´»åŠ¨
        async function testCreateEvent() {
            if (!authToken) {
                showResult('createEventResult', 'âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                showResult('createEventResult', 'æ­£åœ¨åˆ›å»ºæµ‹è¯•æ´»åŠ¨...', 'info');
                const eventData = {
                    title: document.getElementById('eventTitle').value,
                    description: document.getElementById('eventDescription').value,
                    event_date: document.getElementById('eventDate').value,
                    event_time: document.getElementById('eventTime').value,
                    location: document.getElementById('eventLocation').value,
                    speaker_name: 'AWSæŠ€æœ¯ä¸“å®¶',
                    speaker_title: 'äº‘è®¡ç®—æ¶æ„å¸ˆ',
                    speaker_company: 'AWS',
                    max_attendees: 50
                };

                const response = await fetch('/api/events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(eventData)
                });

                const data = await response.json();
                if (data.success && data.data.id) {
                    currentEventId = data.data.id;
                    testResults.createEvent = true;
                    showResult('createEventResult', `âœ… æ´»åŠ¨åˆ›å»ºæˆåŠŸï¼æ´»åŠ¨ID: ${currentEventId}`, 'success');
                } else {
                    testResults.createEvent = false;
                    showResult('createEventResult', `âŒ æ´»åŠ¨åˆ›å»ºå¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                testResults.createEvent = false;
                showResult('createEventResult', `âŒ åˆ›å»ºæ´»åŠ¨è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
            updateButtonStates();
            updateSummary();
        }

        // 4. æµ‹è¯•ç”¨æˆ·æŠ¥å
        async function testRegistration() {
            if (!currentEventId) {
                showResult('registrationResult', 'âŒ è¯·å…ˆåˆ›å»ºæ´»åŠ¨', 'error');
                return;
            }

            try {
                showResult('registrationResult', 'æ­£åœ¨æµ‹è¯•ç”¨æˆ·æŠ¥å...', 'info');
                const registrationData = {
                    name: document.getElementById('regName').value,
                    company: document.getElementById('regCompany').value,
                    position: document.getElementById('regPosition').value,
                    phone: document.getElementById('regPhone').value,
                    email: document.getElementById('regEmail').value,
                    notes: 'é€šè¿‡å¿«é€Ÿæµ‹è¯•é¡µé¢æŠ¥å'
                };

                const response = await fetch(`/api/events/${currentEventId}/registrations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registrationData)
                });

                const data = await response.json();
                if (data.success && data.data.id) {
                    currentRegistrationId = data.data.id;
                    testResults.registration = true;
                    showResult('registrationResult', `âœ… æŠ¥åæˆåŠŸï¼æŠ¥åID: ${currentRegistrationId}`, 'success');
                } else {
                    testResults.registration = false;
                    showResult('registrationResult', `âŒ æŠ¥åå¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                testResults.registration = false;
                showResult('registrationResult', `âŒ æŠ¥åè¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
            updateButtonStates();
            updateSummary();
        }

        // 5. æµ‹è¯•ç­¾åˆ°åŠŸèƒ½
        async function testCheckin() {
            if (!currentRegistrationId || !authToken) {
                showResult('checkinResult', 'âŒ è¯·å…ˆå®ŒæˆæŠ¥åå’Œç™»å½•', 'error');
                return;
            }

            try {
                showResult('checkinResult', 'æ­£åœ¨æµ‹è¯•ç­¾åˆ°åŠŸèƒ½...', 'info');
                const response = await fetch(`/api/registrations/${currentRegistrationId}/checkin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        checked_by: 'admin'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    testResults.checkin = true;
                    showResult('checkinResult', 'âœ… ç­¾åˆ°æˆåŠŸï¼', 'success');
                } else {
                    testResults.checkin = false;
                    showResult('checkinResult', `âŒ ç­¾åˆ°å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                testResults.checkin = false;
                showResult('checkinResult', `âŒ ç­¾åˆ°è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
            updateButtonStates();
            updateSummary();
        }

        // 6. æµ‹è¯•æ•°æ®æŸ¥è¯¢
        async function testDataQuery() {
            if (!authToken || !currentEventId) {
                showResult('queryResult', 'âŒ è¯·å…ˆç™»å½•å¹¶åˆ›å»ºæ´»åŠ¨', 'error');
                return;
            }

            try {
                showResult('queryResult', 'æ­£åœ¨æµ‹è¯•æ•°æ®æŸ¥è¯¢...', 'info');
                
                // æµ‹è¯•è·å–æ´»åŠ¨åˆ—è¡¨
                const eventsResponse = await fetch('/api/events', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const eventsData = await eventsResponse.json();

                // æµ‹è¯•è·å–æŠ¥ååˆ—è¡¨
                const registrationsResponse = await fetch(`/api/events/${currentEventId}/registrations`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const registrationsData = await registrationsResponse.json();

                // æµ‹è¯•è·å–ç­¾åˆ°ç»Ÿè®¡
                const statsResponse = await fetch(`/api/events/${currentEventId}/checkin-stats`);
                const statsData = await statsResponse.json();

                if (eventsData.success && registrationsData.success && statsData.success) {
                    testResults.dataQuery = true;
                    const eventCount = eventsData.data.length;
                    const regCount = registrationsData.data.length;
                    const checkinCount = statsData.data.checked_in_count;
                    
                    showResult('queryResult', 
                        `âœ… æ•°æ®æŸ¥è¯¢æˆåŠŸï¼<br>
                        - æ´»åŠ¨æ•°é‡: ${eventCount}<br>
                        - æŠ¥åäººæ•°: ${regCount}<br>
                        - ç­¾åˆ°äººæ•°: ${checkinCount}`, 'success');
                } else {
                    testResults.dataQuery = false;
                    showResult('queryResult', 'âŒ æ•°æ®æŸ¥è¯¢å¤±è´¥', 'error');
                }
            } catch (error) {
                testResults.dataQuery = false;
                showResult('queryResult', `âŒ æ•°æ®æŸ¥è¯¢è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
            updateButtonStates();
            updateSummary();
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.addEventListener('load', function() {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>